version: '3.8'

services:
  # CoreDNS with etcd backend
  coredns:
    image: coredns/coredns:latest
    container_name: mesh-coredns
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./configs/coredns/Corefile:/etc/coredns/Corefile:ro
      - coredns-data:/data
    command: -conf /etc/coredns/Corefile
    healthcheck:
      test: ["CMD", "sh", "-c", "dig @127.0.0.1 -p 53 mesh.test || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
    cap_add:
      - NET_ADMIN
      - NET_BIND_SERVICE

  # Unbound DNS Cache
  unbound:
    image: nlnetlabs/unbound:latest
    container_name: mesh-unbound
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./configs/unbound/unbound.conf:/opt/unbound/etc/unbound/unbound.conf:ro
      - unbound-data:/opt/unbound/etc/unbound/var
    healthcheck:
      test: ["CMD", "unbound-host", "-t", "A", "cloudflare.com", "127.0.0.1"]
      interval: 30s
      timeout: 5s
      retries: 3
    cap_add:
      - NET_BIND_SERVICE

  # etcd for distributed DNS storage
  etcd:
    image: quay.io/coreos/etcd:v3.5.12
    container_name: mesh-etcd
    restart: unless-stopped
    network_mode: host
    volumes:
      - etcd-data:/etcd-data
    environment:
      - ETCD_NAME=${ETCD_NAME:-node1}
      - ETCD_DATA_DIR=/etcd-data
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_ADVERTISE_CLIENT_URLS=http://${ETCD_IP:-169.254.1.1}:2379
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://${ETCD_IP:-169.254.1.1}:2380
      - ETCD_INITIAL_CLUSTER=${ETCD_CLUSTER:-node1=http://169.254.1.1:2380}
      - ETCD_INITIAL_CLUSTER_STATE=${ETCD_CLUSTER_STATE:-new}
      - ETCD_INITIAL_CLUSTER_TOKEN=mesh-network-cluster
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 30s
      timeout: 5s
      retries: 3

volumes:
  coredns-data:
  unbound-data:
  etcd-data:
