name: Build x86/64 Images

on:
  workflow_dispatch:
    inputs:
      node_type:
        description: 'Node type to build (or "all")'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - mesh-router
          - lan-router
          - gateway-wifi
          - gateway-wired
          - update-cache
          - monitoring
      version:
        description: 'Image version'
        required: true
        default: '1.0.0'
  release:
    types: [published]

env:
  MESH_VERSION: ${{ github.event.inputs.version || github.ref_name }}

jobs:
  build-images:
    name: Build x86/64 - ${{ matrix.node_type }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        node_type: ${{ github.event.inputs.node_type == 'all' && fromJSON('["mesh-router", "lan-router", "gateway-wifi", "gateway-wired", "update-cache", "monitoring"]') || fromJSON(format('["{0}"]', github.event.inputs.node_type)) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo apt-get clean
          docker system prune -af
          sudo df -h

      - name: Enable KVM
        run: |
          # Enable KVM group permissions for GitHub Actions runner
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

          # Add runner user to kvm group
          sudo usermod -aG kvm $USER

          # Verify KVM is available
          ls -la /dev/kvm || echo "Warning: /dev/kvm not found"

      - name: Install dependencies
        run: |
          # Install QEMU and KVM
          sudo apt-get update
          sudo apt-get install -y \
            qemu-kvm \
            qemu-utils \
            libvirt-daemon-system \
            libvirt-clients \
            bridge-utils \
            virtinst \
            libguestfs-tools

          # Enable KVM modules
          sudo modprobe kvm
          sudo modprobe kvm_intel || sudo modprobe kvm_amd || true

          # Final KVM check
          if [ -e /dev/kvm ]; then
            echo "KVM is available"
            ls -la /dev/kvm
          else
            echo "Warning: KVM is NOT available - build may be slow"
          fi

      - name: Build with virt-builder
        env:
          LIBGUESTFS_BACKEND: direct
        run: |
          # Use virt-builder instead of Packer (works without KVM)
          mkdir -p images/output

          # Build Debian image with virt-builder
          virt-builder debian-12 \
            --format qcow2 \
            --output images/output/mesh-network-${{ matrix.node_type }}-${{ env.MESH_VERSION }}-x86_64-base.qcow2 \
            --hostname mesh-${{ matrix.node_type }} \
            --install frr,etcd,docker.io,git,curl,python3-pip \
            --root-password password:mesh \
            --run-command 'useradd -m -s /bin/bash -G sudo,docker mesh && echo "mesh:mesh" | chpasswd' \
            --copy-in scripts:/opt/mesh-network/ \
            --copy-in configs:/opt/mesh-network/ \
            --copy-in systemd:/opt/mesh-network/ \
            --run-command 'cp /opt/mesh-network/systemd/*.service /etc/systemd/system/ || true' \
            --run-command 'systemctl enable frr etcd docker || true' \
            --run-command 'echo "MESH_VERSION=${{ env.MESH_VERSION }}" > /etc/mesh-network-version' \
            --run-command 'echo "NODE_TYPE=${{ matrix.node_type }}" >> /etc/mesh-network-version' \
            --selinux-relabel

          # Resize separately using qemu-img (avoids libguestfs resize issues)
          qemu-img resize images/output/mesh-network-${{ matrix.node_type }}-${{ env.MESH_VERSION }}-x86_64-base.qcow2 8G
          mv images/output/mesh-network-${{ matrix.node_type }}-${{ env.MESH_VERSION }}-x86_64-base.qcow2 \
             images/output/mesh-network-${{ matrix.node_type }}-${{ env.MESH_VERSION }}-x86_64.qcow2

          # Convert to other formats
          cd images/output
          qemu-img convert -f qcow2 -O vmdk mesh-network-${{ matrix.node_type }}-${{ env.MESH_VERSION }}-x86_64.qcow2 mesh-network-${{ matrix.node_type }}-${{ env.MESH_VERSION }}-x86_64.vmdk
          qemu-img convert -f qcow2 -O vdi mesh-network-${{ matrix.node_type }}-${{ env.MESH_VERSION }}-x86_64.qcow2 mesh-network-${{ matrix.node_type }}-${{ env.MESH_VERSION }}-x86_64.vdi
          qemu-img convert -f qcow2 -O vpc mesh-network-${{ matrix.node_type }}-${{ env.MESH_VERSION }}-x86_64.qcow2 mesh-network-${{ matrix.node_type }}-${{ env.MESH_VERSION }}-x86_64.vhd

          # Compress
          xz -9 -T0 *.qcow2 *.vmdk *.vdi *.vhd

          # Checksums
          sha256sum *.xz > checksums.txt
          cat checksums.txt

      - name: List output files
        run: |
          ls -lh images/output/
          cat images/output/checksums.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mesh-network-${{ matrix.node_type }}-${{ env.MESH_VERSION }}-x86_64
          path: |
            images/output/*.xz
            images/output/checksums.txt
          retention-days: 30

      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            images/output/*.xz
            images/output/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-script:
    name: Build x86/64 - ${{ matrix.node_type }} (Script - Legacy)
    runs-on: ubuntu-latest
    if: false  # Disabled - using virt-builder instead

    strategy:
      fail-fast: false
      matrix:
        node_type: ${{ github.event.inputs.node_type == 'all' && fromJSON('["mesh-router", "lan-router", "gateway-wifi", "gateway-wired", "update-cache", "monitoring"]') || fromJSON(format('["{0}"]', github.event.inputs.node_type)) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo apt-get clean
          docker system prune -af
          sudo df -h

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            qemu-kvm qemu-utils \
            libvirt-daemon-system libvirt-clients \
            virtinst virt-manager \
            libguestfs-tools \
            genisoimage \
            rsync

      - name: Build x86/64 Image - ${{ matrix.node_type }}
        run: |
          cd images
          chmod +x build-x86-image.sh
          sudo ./build-x86-image.sh -v ${{ env.MESH_VERSION }} ${{ matrix.node_type }}

      - name: List output files
        run: |
          ls -lh images/output/
          find images/output/ -name "*.sha256" -exec cat {} \;

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mesh-network-${{ matrix.node_type }}-${{ env.MESH_VERSION }}-x86_64-script
          path: |
            images/output/*.xz
            images/output/*.sha256
          retention-days: 30

  create-manifest:
    name: Create x86/64 Manifest
    runs-on: ubuntu-latest
    needs: [build-images]
    if: always() && (github.event_name == 'release' || github.event.inputs.node_type == 'all')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create manifest
        run: |
          cat > manifest-x86.json << EOF
          {
            "version": "${{ env.MESH_VERSION }}",
            "arch": "x86_64",
            "build_date": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')",
            "images": [
          EOF

          first=true
          for dir in artifacts/mesh-network-*-x86_64-*; do
            if [ -d "$dir" ]; then
              node_type=$(basename "$dir" | sed 's/mesh-network-\(.*\)-.*-x86_64.*/\1/')

              # Find all image files
              for image_file in "$dir"/*.tar.xz; do
                if [ -f "$image_file" ]; then
                  sha256_file="${image_file}.sha256"
                  if [ -f "$sha256_file" ]; then
                    size=$(stat -c%s "$image_file")
                    sha256=$(cat "$sha256_file" | awk '{print $1}')
                    format=$(basename "$image_file" | sed 's/.*-\(.*\)\.tar\.xz/\1/')

                    if [ "$first" = true ]; then
                      first=false
                    else
                      echo "," >> manifest-x86.json
                    fi

                    cat >> manifest-x86.json << ITEM
              {
                "node_type": "$node_type",
                "format": "$format",
                "filename": "$(basename $image_file)",
                "size": $size,
                "sha256": "$sha256"
              }
          ITEM
                  fi
                fi
              done
            fi
          done

          cat >> manifest-x86.json << EOF
            ]
          }
          EOF

          cat manifest-x86.json

      - name: Upload manifest
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: manifest-x86.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-images]
    if: always()

    steps:
      - name: Create summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # x86/64 Image Build Summary

          ## Images Built
          - Mesh Router (WiFi + LAN)
          - LAN Router (Wired)
          - Gateway WiFi
          - Gateway Wired
          - Update Cache (LANcache)
          - Monitoring Node (Docker)

          ## Available Formats
          - **QCOW2** - QEMU/KVM (Linux)
          - **RAW** - dd, bare metal
          - **VMDK** - VMware Workstation/ESXi
          - **VDI** - VirtualBox
          - **VHD** - Microsoft Hyper-V

          ## Download
          Check the Artifacts section above or the Release page.

          ## Usage

          ### QEMU/KVM
          ```bash
          xz -d mesh-network-monitoring-1.0.0-x86_64.qcow2.xz
          qemu-system-x86_64 -m 2048 -hda mesh-network-monitoring-1.0.0-x86_64.qcow2
          ```

          ### VMware
          ```bash
          xz -d mesh-network-monitoring-1.0.0-x86_64.vmdk.xz
          # Import into VMware Workstation/ESXi
          ```

          ### VirtualBox
          ```bash
          xz -d mesh-network-monitoring-1.0.0-x86_64.vdi.xz
          # Import into VirtualBox
          ```

          ### Bare Metal (dd)
          ```bash
          xz -d mesh-network-monitoring-1.0.0-x86_64.img.xz
          sudo dd if=mesh-network-monitoring-1.0.0-x86_64.img of=/dev/sdX bs=4M status=progress
          ```

          ## First Boot
          - Username: `mesh`
          - Password: `mesh`
          - Root password: `mesh`
          - SSH enabled by default
          - Run: `/opt/mesh-network/setup.sh`

          EOF
