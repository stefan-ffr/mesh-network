name: Build Raspberry Pi Images

# This workflow uses libguestfs (virt-customize) to build images
# without requiring loop device support. This works in GitHub Actions!

on:
  workflow_dispatch:
    inputs:
      node_type:
        description: 'Node type to build (or "all")'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - mesh-router
          - lan-router
          - gateway-wifi
          - gateway-wired
          - update-cache
          - monitoring
      version:
        description: 'Image version'
        required: true
        default: '1.0.0'
  release:
    types: [published]

env:
  MESH_VERSION: ${{ github.event.inputs.version || github.ref_name }}

jobs:
  build-matrix:
    name: Build Image - ${{ matrix.node_type }}
    runs-on: ubuntu-latest
    if: github.event.inputs.node_type != 'all'

    strategy:
      fail-fast: false
      matrix:
        node_type:
          - ${{ github.event.inputs.node_type }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo df -h

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            wget xz-utils \
            qemu-user-static qemu-utils \
            libguestfs-tools guestfs-tools

          # Verify libguestfs works
          echo "Testing libguestfs..."
          libguestfs-test-tool --timeout 60 || echo "libguestfs test completed"

      - name: Build Raspberry Pi Image
        run: |
          cd images
          chmod +x build-pi-image-guestfs.sh
          # No sudo needed - libguestfs works in userspace!
          ./build-pi-image-guestfs.sh -v ${{ env.MESH_VERSION }} ${{ matrix.node_type }}

      - name: List output files
        run: |
          ls -lh images/output/
          cat images/output/*.sha256

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: mesh-network-${{ matrix.node_type }}-${{ env.MESH_VERSION }}-arm64
          path: |
            images/output/*.img.xz
            images/output/*.sha256
          retention-days: 30
          compression-level: 0  # Already compressed

      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            images/output/*.img.xz
            images/output/*.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-all:
    name: Build All Images
    runs-on: ubuntu-latest
    if: github.event.inputs.node_type == 'all' || github.event_name == 'release'

    strategy:
      fail-fast: false
      matrix:
        node_type:
          - mesh-router
          - lan-router
          - gateway-wifi
          - gateway-wired
          - update-cache
          - monitoring

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo df -h

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            wget xz-utils \
            qemu-user-static qemu-utils \
            libguestfs-tools guestfs-tools

          # Verify libguestfs works
          echo "Testing libguestfs..."
          libguestfs-test-tool --timeout 60 || echo "libguestfs test completed"

      - name: Build Raspberry Pi Image - ${{ matrix.node_type }}
        run: |
          cd images
          chmod +x build-pi-image-guestfs.sh
          # No sudo needed - libguestfs works in userspace!
          ./build-pi-image-guestfs.sh -v ${{ env.MESH_VERSION }} ${{ matrix.node_type }}

      - name: List output files
        run: |
          ls -lh images/output/
          cat images/output/*.sha256 || true

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: mesh-network-${{ matrix.node_type }}-${{ env.MESH_VERSION }}-arm64
          path: |
            images/output/*.img.xz
            images/output/*.sha256
          retention-days: 30
          compression-level: 0

      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            images/output/*.img.xz
            images/output/*.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-manifest:
    name: Create Release Manifest
    runs-on: ubuntu-latest
    needs: [build-all]
    if: github.event_name == 'release' || github.event.inputs.node_type == 'all'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create manifest
        run: |
          cat > manifest.json << EOF
          {
            "version": "${{ env.MESH_VERSION }}",
            "build_date": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')",
            "images": [
          EOF

          first=true
          for dir in artifacts/mesh-network-*; do
            if [ -d "$dir" ]; then
              node_type=$(basename "$dir" | sed 's/mesh-network-\(.*\)-.*-arm64/\1/')
              image_file=$(ls "$dir"/*.img.xz | head -1)
              sha256_file=$(ls "$dir"/*.sha256 | head -1)

              if [ -f "$image_file" ] && [ -f "$sha256_file" ]; then
                size=$(stat -c%s "$image_file")
                sha256=$(cat "$sha256_file" | awk '{print $1}')

                if [ "$first" = true ]; then
                  first=false
                else
                  echo "," >> manifest.json
                fi

                cat >> manifest.json << ITEM
              {
                "node_type": "$node_type",
                "filename": "$(basename $image_file)",
                "size": $size,
                "sha256": "$sha256"
              }
          ITEM
              fi
            fi
          done

          cat >> manifest.json << EOF
            ]
          }
          EOF

          cat manifest.json

      - name: Upload manifest
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: manifest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-all]
    if: always()

    steps:
      - name: Create summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # Raspberry Pi Image Build Summary

          ## Images Built
          - Mesh Router (WiFi + LAN)
          - LAN Router (Wired)
          - Gateway WiFi
          - Gateway Wired
          - Update Cache (LANcache)
          - Monitoring Node (Docker)

          ## Download
          Check the Artifacts section above or the Release page for downloads.

          ## Usage
          1. Download the appropriate `.img.xz` file for your node type
          2. Verify checksum: `sha256sum -c mesh-network-*.img.xz.sha256`
          3. Extract: `xz -d mesh-network-*.img.xz`
          4. Flash to SD card: `sudo dd if=mesh-network-*.img of=/dev/sdX bs=4M status=progress`
          5. Boot your Raspberry Pi

          ## Configuration
          After first boot, configure via:
          - SSH: `ssh pi@raspberrypi.local` (default password: raspberry)
          - Run setup: `/opt/mesh-network/setup.sh`

          EOF
